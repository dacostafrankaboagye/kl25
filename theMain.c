#include <stdio.h>
#include <MKL25Z4.h>
#include <stdint.h>
#include <string.h>
#include <math.h>
#include "theLcd.h"



#define CS (0)
#define MOSI (2)
#define SCK (1)

#define MASK(X) (1<<X)

// keypad
#define ROW0 (3)  				//PTD3
#define ROW1 (4)  				//PTD4
#define ROW2 (5)  				//PTD5
#define ROW3 (6)  				//PTD6
#define COL0 (8)  				//PTB8
#define COL1 (9)  				//PTB9
#define COL2 (10)  				//PTB10
#define COL3 (11)  				//PTB11


#define LED_RED	(18)  					//PTB18


// variable declaration
int count = 0;
uint8_t out_of_ten = 0;

int dutyCycle = 0;
//uint8_t dutyCycle = 0;
int currentDuty = 50;
uint8_t dummy;
static uint8_t waveNumber = 1; // 0/1 = square  4/5 triangle
static int modSquareValue[5] = {3050,1499,999,750,600};//  111Hz=1500  206Hz=810 309Hz=540 397Hz=420 506Hz=330
static int modValue =3050; // by default for the square
static int volt = 0;
static int forT = 0;
static int Sawtooth_Frequency= 170; //  @1500 mod value => 10000=501.9Hz, 700=400Hz
static int sawToothFrequency[5] = {170, 350, 535,700,1000};

static int triangularFrequency[5]= {4,5,6,7,8};
static int Triangular_Frequency = 10; // @1500 mod  // 10=200Hz
static int currentMod = 100;

static int sineFrequency = 3; // @ mod value = 300  3=116.5Hz  5=192.67 8=313.18 11=417.42Hz 13=500.87
static int sineFrequencyArr[5] = {3,5,8,9,11};

// DAC functions
void DAC_init();
void DAC_write(uint16_t value);
void DAC_write_atomic(uint8_t value);
void init_Timer();



// for the keypad
void keypadInit();
void callKeyPad();



// other Functions
void redLedSetUp();
void squareWave();
void increaseDutyCycle();
void decreaseDutyCycle();
uint16_t DAC_volt_conv(uint16_t voltage);

void sawTooth();



int main(void){

	// activate the LCD pins
	setDataPins();
	setControlPins();

	keypadInit(); // activate the keypad
	LCD_init(); // initialize the LCd

	LCD_command(0X0F); // for testing _ blink command
	//delay_ms(20);

	// LCD_write_string(char letter);
	LCD_write_string('C');

	// LCD_write_word(char word[])
	//LCD_write_word("testing");
	redLedSetUp();


//
//
//
	__disable_irq();
	init_Timer();
	LCD_write_string('H');
	 LCD_write_word("starting...");
	DAC_init();
    __enable_irq();








    LCD_write_string('D');

	//LCD_command(0x06);
	makeRsLow();
	makeRwLow();
	LCD_command(0xC0); // change cursor
	LCD_write_string('E');

    while(1){
    	callKeyPad();


    }
    //dispfreq();
    //static uint8_t dispVal = 0x80;
	//while(1){
		//interface_keypad(dispVal);
	//}
	//return 0;
}


void redLedSetUp(){
	SIM->SCGC5|= (1UL<<10) ;

	PORTB->PCR[LED_RED] &= ~0x700;
	PORTB->PCR[LED_RED] |= (1UL<<8);

	//set up led to be output
	PTB->PDDR |=  (1 << LED_RED ) ;
}

void DAC_init(){
	SIM->SCGC5 |= SIM_SCGC5_PORTD_MASK;
	SIM->SCGC4 |= SIM_SCGC4_SPI0_MASK;



	PORTD->PCR[MOSI] |= PORT_PCR_MUX(2); // serial communication
	PORTD->PCR[SCK]  |= PORT_PCR_MUX(2); // serial communication
	PORTD->PCR[CS]   |= PORT_PCR_MUX(1); // gpio

	SPI0->C1 &=~ MASK(6); // disable the spi for now

	PTD->PDDR |= (1UL << CS); // making the CS as output

	SPI0->C1 |= 0x5C ; // spie=0 spe=1 sptie=0 mstr=1 cpol=1 cpha=1 ssoe=0 lsbte=0
	SPI0->C2 |= 0X80;

	SPI0->BR |= 0X00; // for speed of clock
	SPI0->S  |= 0X00;  // for status

	SPI0->C1 |= MASK(6); // enable the spi *** but already  === clear it

	// making the CS high -> [note that, we have to make low when writing]
	PTD->PDOR |= (1UL << CS);

	SPI0 -> C1 |=  MASK(6); // enable the spi for now //---


}
void DAC_write_atomic(uint8_t value){

	while(!(SPI0->S & SPI_S_SPTEF_MASK));
	SPI0->D = value;

	while(!(SPI0->S & SPI_S_SPRF_MASK));
	dummy = SPI0->D;
}

void DAC_write(uint16_t value){
	PTD->PCOR |= (1 << CS); // making the CS low

	uint16_t data = 0x0FFF & value; // ==== FFF
	data = 0x3000 | data;

	uint8_t tmp = data >> 8; // fist 4 data bit
	DAC_write_atomic(tmp);

	tmp = data;  // last 8
	DAC_write_atomic(tmp);

	//set the cs to high now
	PTD->PSOR |= (1 << CS);

}

uint16_t DAC_volt_conv(uint16_t voltage) {
            if (voltage > 3300){
            	return 0xFFF;
            }
            else{
            	return ceil((voltage*4095)/3300);
            }

}

uint16_t DAC_volt_conv2(uint16_t voltage) {

            	return ceil((voltage*4095)/3300);

}

void squareWave(){

	out_of_ten= currentDuty/10; 				//duty cycle = 50%

	if(count < out_of_ten){
		DAC_write(0xE8B);  // offset - 1.5
		//DAC_write(0x000);
		count = (count+1)%10;

	}
	else{
		DAC_write(0x000); // - 3V
		//DAC_write(0xFFF);
		count = (count+1)%10;

	}


}


void sawTooth(){

	volt+=Sawtooth_Frequency;

	if (volt >= 3300){
		 volt = 0;
	}
	DAC_write(DAC_volt_conv(volt));


}


//static unsigned int triangleValues[100] = {0x000,0x04C,0x098,0x0E4,0x130,0x17C,0x1C8,0x214,0x260,0x2AC,0x2F8,0x344,0x390,0x3DC,0x428,0x474,0x4C0,0x50C,0x558,0x5A4,0x5F0,0x63C,0x688,0x6D4,0x720,0x76C,0x7B8,0x804,0x850,0x89C,0x8E8,0x934,0x980,0x9CC,0xA18,0xA64,0xAB0,0xAFC,0xB48,0xB93,0xBDF,0xC2B,0xC77,0xCC3,0xD0F,0xD5B,0xDA7,0xDF3,0xE3F,0xE8B,0xE7F,0xE33,0xDE7,0xD9C,0xD50,0xD04,0xCB8,0xC6D,0xC21,0xBD5,0xB8A,0xB3E,0xAF2,0xAA6,0xA5B,0xA0F,0x9C3,0x978,0x92C,0x8E0,0x894,0x849,0x7FD,0x7B1,0x766,0x71A,0x6CE,0x682,0x637,0x5EB,0x59F,0x553,0x508,0x4BC,0x470,0x425,0x3D9,0x38D,0x341,0x2F6,0x2AA,0x25E,0x213,0x1C7,0x17B,0x12F,0x0E4,0x098,0x04C,0x000};
static unsigned int triangleValues[520]= {0, 48, 95, 143,191,238 ,286, 333 , 381, 429, 476, 524, 571,619,667, 714, 762,810, 857,905,952,1000, 1048,1095,1143,1191,1238,1286,1333,1381,1429,1476,1524,1571,1619,1667,1714,1762,1810,1857,1905,  1952,2000, 2048, 2095, 2143, 2191,2238, 2286, 2333, 2381, 2429,2476,2524,2571, 2619,2667,   2714, 2762, 2809, 2857,2905, 2952,3000,3000,2952,2905,2857,2809,2762,2714,2667,2619,2571,2524,2476,2429,2381,2333,2286,2238,2191,2143,2095,2048,2000,1952,1905,1857,1810,1762,1714,1667,1619,1571,1524,1476,1429,1381,1333,1286,1238,1191,1143,1095,1048,1000,952,905,857,810,762,714,667,619,571,524,476,429,381,333,286,238,191,143,95,48,0,0, 48, 95, 143,191,238 ,286, 333 , 381, 429, 476, 524, 571,619,667, 714, 762,810, 857,905,952,1000, 1048,1095,1143,1191,1238,1286,1333,1381,1429,1476,1524,1571,1619,1667,1714,1762,1810,1857,1905,  1952,2000, 2048, 2095, 2143, 2191,2238, 2286, 2333, 2381, 2429,2476,2524,2571, 2619,2667,   2714, 2762, 2809, 2857,2905, 2952,3000,3000,2952,2905,2857,2809,2762,2714,2667,2619,2571,2524,2476,2429,2381,2333,2286,2238,2191,2143,2095,2048,2000,1952,1905,1857,1810,1762,1714,1667,1619,1571,1524,1476,1429,1381,1333,1286,1238,1191,1143,1095,1048,1000,952,905,857,810,762,714,667,619,571,524,476,429,381,333,286,238,191,143,95,48,0,0, 48, 95, 143,191,238 ,286, 333 , 381, 429, 476, 524, 571,619,667, 714, 762,810, 857,905,952,1000, 1048,1095,1143,1191,1238,1286,1333,1381,1429,1476,1524,1571,1619,1667,1714,1762,1810,1857,1905,  1952,2000, 2048, 2095, 2143, 2191,2238, 2286, 2333, 2381, 2429,2476,2524,2571, 2619,2667,   2714, 2762, 2809, 2857,2905, 2952,3000,3000,2952,2905,2857,2809,2762,2714,2667,2619,2571,2524,2476,2429,2381,2333,2286,2238,2191,2143,2095,2048,2000,1952,1905,1857,1810,1762,1714,1667,1619,1571,1524,1476,1429,1381,1333,1286,1238,1191,1143,1095,1048,1000,952,905,857,810,762,714,667,619,571,524,476,429,381,333,286,238,191,143,95,48,0,0, 48, 95, 143,191,238 ,286, 333 , 381, 429, 476, 524, 571,619,667, 714, 762,810, 857,905,952,1000, 1048,1095,1143,1191,1238,1286,1333,1381,1429,1476,1524,1571,1619,1667,1714,1762,1810,1857,1905,  1952,2000, 2048, 2095, 2143, 2191,2238, 2286, 2333, 2381, 2429,2476,2524,2571, 2619,2667,   2714, 2762, 2809, 2857,2905, 2952,3000,3000,2952,2905,2857,2809,2762,2714,2667,2619,2571,2524,2476,2429,2381,2333,2286,2238,2191,2143,2095,2048,2000,1952,1905,1857,1810,1762,1714,1667,1619,1571,1524,1476,1429,1381,1333,1286,1238,1191,1143,1095,1048,1000,952,905,857,810,762,714,667,619,571,524,476,429,381,333,286,238,191,143,95,48,0};
static int index = 0;
static int tmp = 0;
static int storeV = 0;
static int left = 0;


int sineArray[256] = {1654,1687,1720,1754,1786,1819,1852,1884,1917,1950,1981,2013,2045,2077,2108,2139,2169,2200,2230,2259,2289,2318,2346,2375,2402,2430,2456,2483,2509,2534,2559,2583,2606,2630,2652,2674,2695,2716,2736,2756,2774,2792,2809,2826,2842,2857,2871,2885,2898,2911,2922,2933,2943,2952,2961,2968,2975,2981,2986,2991,2994,2997,3000,3000,3001,3000,3000,2997,2994,2991,2986,2981,2975,2968,2961,2952,2943,2933,2922,2911,2898,2885,2871,2857,2842,2826,2809,2792,2774,2756,2736,2716,2695,2674,2652,2630,2606,2583,2559,2534,2509,2483,2456,2430,2402,2375,2346,2318,2289,2259,2230,2200,2169,2139,2108,2077,2045,2013,1981,1950,1917,1884,1852,1819,1786,1754,1720,1687,1654,1621,1588,1555,1522,1489,1457,1424,1392,1359,1327,1295,1263,1232,1200,1169,1139,1108,1079,1049,1019,990,962,934,906,879,852,826,800,775,750,726,702,679,656,634,613,592,573,553,534,517,499,483,467,452,437,423,410,398,386,375,365,356,348,340,333,327,322,317,314,311,309,308,308,308,309,311,314,317,322,327,333,340,348,356,365,375,386,398,410,423,437,452,467,483,499,517,534,553,573,592,613,634,656,679,702,726,750,775,800,826,852,879,906,934,962,990,1019,1049,1079,1108,1139,1169,1200,1232,1263,1295,1327,1359,1392,1424,1457,1489,1522,1555,1588,1621};

static int i=0;
static int a = 3300;

uint16_t sinusoidal[] ={1861,1873,1885,1896,1908,1920,1931,1943,1955,1967,1978,1990,2002,2013,2025,2037,2048,2060,2071,2083,2095,2106,2118,2129,2141,2153,2164,2176,2187,2199,2210,2222,2233,2245,2256,2267,2279,2290,2302,2313,2324,2336,2347,2358,2369,2381,2392,2403,2414,2425,2437,2448,2459,2470,2481,2492,2503,2514,2525,2536,2547,2558,2568,2579,2590,2601,2611,2622,2633,2643,2654,2665,2675,2686,2696,2707,2717,2727,2738,2748,2758,2768,2779,2789,2799,2809,2819,2829,2839,2849,2859,2869,2879,2888,2898,2908,2917,2927,2937,2946,2956,2965,2974,2984,2993,3002,3012,3021,3030,3039,3048,3057,3066,3075,3084,3093,3101,3110,3119,3127,3136,3144,3153,3161,3169,3178,3186,3194,3202,3210,3218,3226,3234,3242,3250,3258,3266,3273,3281,3288,3296,3303,3311,3318,3325,3332,3340,3347,3354,3361,3368,3374,3381,3388,3395,3401,3408,3414,3421,3427,3433,3440,3446,3452,3458,3464,3470,3476,3481,3487,3493,3498,3504,3509,3515,3520,3525,3531,3536,3541,3546,3551,3556,3561,3565,3570,3575,3579,3584,3588,3592,3597,3601,3605,3609,3613,3617,3621,3625,3628,3632,3636,3639,3643,3646,3649,3652,3656,3659,3662,3665,3667,3670,3673,3676,3678,3681,3683,3686,3688,3690,3692,3694,3696,3698,3700,3702,3704,3705,3707,3708,3710,3711,3712,3714,3715,3716,3717,3718,3719,3719,3720,3721,3721,3722,3722,3723,3723,3723,3723,3723,3723,3723,3723,3723,3722,3722,3721,3721,3720,3719,3719,3718,3717,3716,3715,3714,3712,3711,3710,3708,3707,3705,3704,3702,3700,3698,3696,3694,3692,3690,3688,3686,3683,3681,3678,3676,3673,3670,3667,3665,3662,3659,3656,3652,3649,3646,3643,3639,3636,3632,3628,3625,3621,3617,3613,3609,3605,3601,3597,3592,3588,3584,3579,3575,3570,3565,3561,3556,3551,3546,3541,3536,3531,3525,3520,3515,3509,3504,3498,3493,3487,3481,3476,3470,3464,3458,3452,3446,3440,3433,3427,3421,3414,3408,3401,3395,3388,3381,3374,3368,3361,3354,3347,3340,3332,3325,3318,3311,3303,3296,3288,3281,3273,3266,3258,3250,3242,3234,3226,3218,3210,3202,3194,3186,3178,3169,3161,3153,3144,3136,3127,3119,3110,3101,3093,3084,3075,3066,3057,3048,3039,3030,3021,3012,3002,2993,2984,2974,2965,2956,2946,2937,2927,2917,2908,2898,2888,2879,2869,2859,2849,2839,2829,2819,2809,2799,2789,2779,2768,2758,2748,2738,2727,2717,2707,2696,2686,2675,2665,2654,2643,2633,2622,2611,2601,2590,2579,2568,2558,2547,2536,2525,2514,2503,2492,2481,2470,2459,2448,2437,2425,2414,2403,2392,2381,2369,2358,2347,2336,2324,2313,2302,2290,2279,2267,2256,2245,2233,2222,2210,2199,2187,2176,2164,2153,2141,2129,2118,2106,2095,2083,2071,2060,2048,2037,2025,2013,2002,1990,1978,1967,1955,1943,1931,1920,1908,1896,1885,1873,1861,1850,1838,1826,1815,1803,1791,1779,1768,1756,1744,1733,1721,1709,1698,1686,1674,1663,1651,1640,1628,1616,1605,1593,1582,1570,1559,1547,1535,1524,1512,1501,1489,1478,1467,1455,1444,1432,1421,1410,1398,1387,1376,1364,1353,1342,1331,1319,1308,1297,1286,1275,1264,1253,1242,1231,1220,1209,1198,1187,1176,1165,1154,1143,1133,1122,1111,1100,1090,1079,1069,1058,1047,1037,1027,1016,1006,995,985,975,964,954,944,934,924,914,904,894,884,874,864,854,844,834,825,815,805,796,786,776,767,758,748,739,729,720,711,702,693,684,675,666,657,648,639,630,621,613,604,595,587,578,570,561,553,545,537,528,520,512,504,496,488,480,473,465,457,449,442,434,427,419,412,405,397,390,383,376,369,362,355,348,341,335,328,321,315,308,302,296,289,283,277,271,265,259,253,247,241,235,230,224,219,213,208,202,197,192,187,182,177,172,167,162,157,153,148,143,139,135,130,126,122,118,114,110,106,102,98,94,91,87,84,80,77,73,70,67,64,61,58,55,52,50,47,44,42,39,37,35,32,30,28,26,24,22,21,19,17,16,14,13,11,10,9,8,7,6,5,4,3,2,2,1,1,0,0,0,0,0,0,0,0,0,0,0,1,1,2,2,3,4,5,6,7,8,9,10,11,13,14,16,17,19,21,22,24,26,28,30,32,35,37,39,42,44,47,50,52,55,58,61,64,67,70,73,77,80,84,87,91,94,98,102,106,110,114,118,122,126,130,135,139,143,148,153,157,162,167,172,177,182,187,192,197,202,208,213,219,224,230,235,241,247,253,259,265,271,277,283,289,296,302,308,315,321,328,335,341,348,355,362,369,376,383,390,397,405,412,419,427,434,442,449,457,465,473,480,488,496,504,512,520,528,537,545,553,561,570,578,587,595,604,613,621,630,639,648,657,666,675,684,693,702,711,720,729,739,748,758,767,776,786,796,805,815,825,834,844,854,864,874,884,894,904,914,924,934,944,954,964,975,985,995,1006,1016,1027,1037,1047,1058,1069,1079,1090,1100,1111,1122,1133,1143,1154,1165,1176,1187,1198,1209,1220,1231,1242,1253,1264,1275,1286,1297,1308,1319,1331,1342,1353,1364,1376,1387,1398,1410,1421,1432,1444,1455,1467,1478,1489,1501,1512,1524,1535,1547,1559,1570,1582,1593,1605,1616,1628,1640,1651,1663,1674,1686,1698,1709,1721,1733,1744,1756,1768,1779,1791,1803,1815,1826,1838,1850,1861};
uint16_t triangle[]= {0,7,14,22,29,37,44,52,59,67,74,81,89,96,104,111,119,126,134,141,148,156,163,171,178,186,193,201,208,215,223,230,238,245,253,260,268,275,282,290,297,305,312,320,327,335,342,350,357,364,372,379,387,394,402,409,417,424,431,439,446,454,461,469,476,484,491,498,506,513,521,528,536,543,551,558,565,573,580,588,595,603,610,618,625,633,640,647,655,662,670,677,685,692,700,707,714,722,729,737,744,752,759,767,774,781,789,796,804,811,819,826,834,841,848,856,863,871,878,886,893,901,908,916,923,930,938,945,953,960,968,975,983,990,997,1005,1012,1020,1027,1035,1042,1050,1057,1064,1072,1079,1087,1094,1102,1109,1117,1124,1131,1139,1146,1154,1161,1169,1176,1184,1191,1198,1206,1213,1221,1228,1236,1243,1251,1258,1266,1273,1280,1288,1295,1303,1310,1318,1325,1333,1340,1347,1355,1362,1370,1377,1385,1392,1400,1407,1414,1422,1429,1437,1444,1452,1459,1467,1474,1481,1489,1496,1504,1511,1519,1526,1534,1541,1549,1556,1563,1571,1578,1586,1593,1601,1608,1616,1623,1630,1638,1645,1653,1660,1668,1675,1683,1690,1697,1705,1712,1720,1727,1735,1742,1750,1757,1764,1772,1779,1787,1794,1802,1809,1817,1824,1832,1839,1846,1854,1861,1869,1876,1884,1891,1899,1906,1913,1921,1928,1936,1943,1951,1958,1966,1973,1980,1988,1995,2003,2010,2018,2025,2033,2040,2047,2055,2062,2070,2077,2085,2092,2100,2107,2115,2122,2129,2137,2144,2152,2159,2167,2174,2182,2189,2196,2204,2211,2219,2226,2234,2241,2249,2256,2263,2271,2278,2286,2293,2301,2308,2316,2323,2330,2338,2345,2353,2360,2368,2375,2383,2390,2397,2405,2412,2420,2427,2435,2442,2450,2457,2465,2472,2479,2487,2494,2502,2509,2517,2524,2532,2539,2546,2554,2561,2569,2576,2584,2591,2599,2606,2613,2621,2628,2636,2643,2651,2658,2666,2673,2680,2688,2695,2703,2710,2718,2725,2733,2740,2748,2755,2762,2770,2777,2785,2792,2800,2807,2815,2822,2829,2837,2844,2852,2859,2867,2874,2882,2889,2896,2904,2911,2919,2926,2934,2941,2949,2956,2963,2971,2978,2986,2993,3001,3008,3016,3023,3031,3038,3045,3053,3060,3068,3075,3083,3090,3098,3105,3112,3120,3127,3135,3142,3150,3157,3165,3172,3179,3187,3194,3202,3209,3217,3224,3232,3239,3246,3254,3261,3269,3276,3284,3291,3299,3306,3314,3321,3328,3336,3343,3351,3358,3366,3373,3381,3388,3395,3403,3410,3418,3425,3433,3440,3448,3455,3462,3470,3477,3485,3492,3500,3507,3515,3522,3529,3537,3544,3552,3559,3567,3574,3582,3589,3596,3604,3611,3619,3626,3634,3641,3649,3656,3664,3671,3678,3686,3693,3701,3708,3716,3723,3723,3716,3708,3701,3693,3686,3678,3671,3664,3656,3649,3641,3634,3626,3619,3611,3604,3596,3589,3582,3574,3567,3559,3552,3544,3537,3529,3522,3515,3507,3500,3492,3485,3477,3470,3462,3455,3448,3440,3433,3425,3418,3410,3403,3395,3388,3381,3373,3366,3358,3351,3343,3336,3328,3321,3314,3306,3299,3291,3284,3276,3269,3261,3254,3246,3239,3232,3224,3217,3209,3202,3194,3187,3179,3172,3165,3157,3150,3142,3135,3127,3120,3112,3105,3098,3090,3083,3075,3068,3060,3053,3045,3038,3031,3023,3016,3008,3001,2993,2986,2978,2971,2963,2956,2949,2941,2934,2926,2919,2911,2904,2896,2889,2882,2874,2867,2859,2852,2844,2837,2829,2822,2815,2807,2800,2792,2785,2777,2770,2762,2755,2748,2740,2733,2725,2718,2710,2703,2695,2688,2680,2673,2666,2658,2651,2643,2636,2628,2621,2613,2606,2599,2591,2584,2576,2569,2561,2554,2546,2539,2532,2524,2517,2509,2502,2494,2487,2479,2472,2465,2457,2450,2442,2435,2427,2420,2412,2405,2397,2390,2383,2375,2368,2360,2353,2345,2338,2330,2323,2316,2308,2301,2293,2286,2278,2271,2263,2256,2249,2241,2234,2226,2219,2211,2204,2196,2189,2182,2174,2167,2159,2152,2144,2137,2129,2122,2115,2107,2100,2092,2085,2077,2070,2062,2055,2047,2040,2033,2025,2018,2010,2003,1995,1988,1980,1973,1966,1958,1951,1943,1936,1928,1921,1913,1906,1899,1891,1884,1876,1869,1861,1854,1846,1839,1832,1824,1817,1809,1802,1794,1787,1779,1772,1764,1757,1750,1742,1735,1727,1720,1712,1705,1697,1690,1683,1675,1668,1660,1653,1645,1638,1630,1623,1616,1608,1601,1593,1586,1578,1571,1563,1556,1549,1541,1534,1526,1519,1511,1504,1496,1489,1481,1474,1467,1459,1452,1444,1437,1429,1422,1414,1407,1400,1392,1385,1377,1370,1362,1355,1347,1340,1333,1325,1318,1310,1303,1295,1288,1280,1273,1266,1258,1251,1243,1236,1228,1221,1213,1206,1198,1191,1184,1176,1169,1161,1154,1146,1139,1131,1124,1117,1109,1102,1094,1087,1079,1072,1064,1057,1050,1042,1035,1027,1020,1012,1005,997,990,983,975,968,960,953,945,938,930,923,916,908,901,893,886,878,871,863,856,848,841,834,826,819,811,804,796,789,781,774,767,759,752,744,737,729,722,714,707,700,692,685,677,670,662,655,647,640,633,625,618,610,603,595,588,580,573,565,558,551,543,536,528,521,513,506,498,491,484,476,469,461,454,446,439,431,424,417,409,402,394,387,379,372,364,357,350,342,335,327,320,312,305,297,290,282,275,268,260,253,245,238,230,223,215,208,201,193,186,178,171,163,156,148,141,134,126,119,111,104,96,89,81,74,67,59,52,44,37,29,22,14,7,0};

//uint16_t sawTooth[]={1861,1865,1869,1872,1876,1880,1884,1887,1891,1895,1899,1902,1906,1910,1913,1917,1921,1925,1928,1932,1936,1939,1943,1947,1951,1954,1958,1962,1966,1969,1973,1977,1980,1984,1988,1992,1995,1999,2003,2007,2010,2014,2018,2021,2025,2029,2033,2036,2040,2044,2047,2051,2055,2059,2062,2066,2070,2074,2077,2081,2085,2088,2092,2096,2100,2103,2107,2111,2115,2118,2122,2126,2129,2133,2137,2141,2144,2148,2152,2155,2159,2163,2167,2170,2174,2178,2182,2185,2189,2193,2196,2200,2204,2208,2211,2215,2219,2222,2226,2230,2234,2237,2241,2245,2249,2252,2256,2260,2263,2267,2271,2275,2278,2282,2286,2290,2293,2297,2301,2304,2308,2312,2316,2319,2323,2327,2330,2334,2338,2342,2345,2349,2353,2357,2360,2364,2368,2371,2375,2379,2383,2386,2390,2394,2397,2401,2405,2409,2412,2416,2420,2424,2427,2431,2435,2438,2442,2446,2450,2453,2457,2461,2465,2468,2472,2476,2479,2483,2487,2491,2494,2498,2502,2505,2509,2513,2517,2520,2524,2528,2532,2535,2539,2543,2546,2550,2554,2558,2561,2565,2569,2573,2576,2580,2584,2587,2591,2595,2599,2602,2606,2610,2613,2617,2621,2625,2628,2632,2636,2640,2643,2647,2651,2654,2658,2662,2666,2669,2673,2677,2680,2684,2688,2692,2695,2699,2703,2707,2710,2714,2718,2721,2725,2729,2733,2736,2740,2744,2748,2751,2755,2759,2762,2766,2770,2774,2777,2781,2785,2788,2792,2796,2800,2803,2807,2811,2815,2818,2822,2826,2829,2833,2837,2841,2844,2848,2852,2856,2859,2863,2867,2870,2874,2878,2882,2885,2889,2893,2896,2900,2904,2908,2911,2915,2919,2923,2926,2930,2934,2937,2941,2945,2949,2952,2956,2960,2963,2967,2971,2975,2978,2982,2986,2990,2993,2997,3001,3004,3008,3012,3016,3019,3023,3027,3031,3034,3038,3042,3045,3049,3053,3057,3060,3064,3068,3071,3075,3079,3083,3086,3090,3094,3098,3101,3105,3109,3112,3116,3120,3124,3127,3131,3135,3138,3142,3146,3150,3153,3157,3161,3165,3168,3172,3176,3179,3183,3187,3191,3194,3198,3202,3206,3209,3213,3217,3220,3224,3228,3232,3235,3239,3243,3246,3250,3254,3258,3261,3265,3269,3273,3276,3280,3284,3287,3291,3295,3299,3302,3306,3310,3314,3317,3321,3325,3328,3332,3336,3340,3343,3347,3351,3354,3358,3362,3366,3369,3373,3377,3381,3384,3388,3392,3395,3399,3403,3407,3410,3414,3418,3421,3425,3429,3433,3436,3440,3444,3448,3451,3455,3459,3462,3466,3470,3474,3477,3481,3485,3489,3492,3496,3500,3503,3507,3511,3515,3518,3522,3526,3529,3533,3537,3541,3544,3548,3552,3556,3559,3563,3567,3570,3574,3578,3582,3585,3589,3593,3596,3600,3604,3608,3611,3615,3619,3623,3626,3630,3634,3637,3641,3645,3649,3652,3656,3660,3664,3667,3671,3675,3678,3682,3686,3690,3693,3697,3701,3704,3708,3712,3716,3719,3723,0,3,7,11,14,18,22,26,29,33,37,40,44,48,52,55,59,63,67,70,74,78,81,85,89,93,96,100,104,107,111,115,119,122,126,130,134,137,141,145,148,152,156,160,163,167,171,175,178,182,186,189,193,197,201,204,208,212,215,219,223,227,230,234,238,242,245,249,253,256,260,264,268,271,275,279,282,286,290,294,297,301,305,309,312,316,320,323,327,331,335,338,342,346,350,353,357,361,364,368,372,376,379,383,387,390,394,398,402,405,409,413,417,420,424,428,431,435,439,443,446,450,454,458,461,465,469,472,476,480,484,487,491,495,498,502,506,510,513,517,521,525,528,532,536,539,543,547,551,554,558,562,565,569,573,577,580,584,588,592,595,599,603,606,610,614,618,621,625,629,633,636,640,644,647,651,655,659,662,666,670,673,677,681,685,688,692,696,700,703,707,711,714,718,722,726,729,733,737,740,744,748,752,755,759,763,767,770,774,778,781,785,789,793,796,800,804,808,811,815,819,822,826,830,834,837,841,845,848,852,856,860,863,867,871,875,878,882,886,889,893,897,901,904,908,912,916,919,923,927,930,934,938,942,945,949,953,956,960,964,968,971,975,979,983,986,990,994,997,1001,1005,1009,1012,1016,1020,1023,1027,1031,1035,1038,1042,1046,1050,1053,1057,1061,1064,1068,1072,1076,1079,1083,1087,1091,1094,1098,1102,1105,1109,1113,1117,1120,1124,1128,1131,1135,1139,1143,1146,1150,1154,1158,1161,1165,1169,1172,1176,1180,1184,1187,1191,1195,1198,1202,1206,1210,1213,1217,1221,1225,1228,1232,1236,1239,1243,1247,1251,1254,1258,1262,1266,1269,1273,1277,1280,1284,1288,1292,1295,1299,1303,1306,1310,1314,1318,1321,1325,1329,1333,1336,1340,1344,1347,1351,1355,1359,1362,1366,1370,1374,1377,1381,1385,1388,1392,1396,1400,1403,1407,1411,1414,1418,1422,1426,1429,1433,1437,1441,1444,1448,1452,1455,1459,1463,1467,1470,1474,1478,1481,1485,1489,1493,1496,1500,1504,1508,1511,1515,1519,1522,1526,1530,1534,1537,1541,1545,1549,1552,1556,1560,1563,1567,1571,1575,1578,1582,1586,1589,1593,1597,1601,1604,1608,1612,1616,1619,1623,1627,1630,1634,1638,1642,1645,1649,1653,1657,1660,1664,1668,1671,1675,1679,1683,1686,1690,1694,1697,1701,1705,1709,1712,1716,1720,1724,1727,1731,1735,1738,1742,1746,1750,1753,1757,1761,1764,1768,1772,1776,1779,1783,1787,1791,1794,1798,1802,1805,1809,1813,1817,1820,1824,1828,1832,1835,1839,1843,1846,1850,1854,1858,1861};


void triangular(){

	// previous
	uint16_t v = DAC_volt_conv2(triangleValues[i]);
	DAC_write(v);
	i +=Triangular_Frequency;
	if(i>=520){
		i = 0;
	}

	// uint16_t v = DAC_volt_conv2(triangleValues[i]);
//	DAC_write(DAC_volt_conv2(triangle[i]));
//	i +=Triangular_Frequency;
//	if(i>=1001){
//		i = 0;
//	}

//	uint8_t n = Triangular_Frequency/100;
//	modValue = 29;
//	static uint8_t i = 0;
//	if(i>=1001){
//		DAC_write(triangle[i]);
//		i = 0;
//	}else{
//		DAC_write(triangle[i]);
//		i+=n;
//	}





}
void sineWave(){

		uint16_t v = DAC_volt_conv2(sineArray[i]);
		DAC_write(v);
		i +=sineFrequency;
		if(i>=256){
			i = 0;
		}



}

void init_Timer(){
	// timer clk on
	SIM->SCGC6 |=SIM_SCGC6_TPM0_MASK;
	//TPMSRC = 0b01 --> select the MCG clock
	//remember: the MCG is set to the FLL which runs at 20.9 MHz
	SIM->SOPT2 |= MASK(24);
	SIM->SOPT2 &= ~MASK(16);
	MCG->C1 |= MCG_C1_CLKS(0);      // Select PLL/FLL as clock source
	MCG->C1 |= MCG_C1_IREFS(1);     // Sel Internal Reference clock for FLL
	MCG->C4 |= MCG_C4_DRST_DRS(1);     // Select DCO range as Mid range
	MCG->C4 |= MCG_C4_DMX32(1);        // Select DCO frequency as 48Mhz

	//Configure registers in TPM0
	//MOD register is the counter-compare value
	//calculateMod(200);
	TPM0->MOD= modValue;   // [for square=30]
	TPM0->SC |= 0x3; //optional pre-scale by 2^3 =8
	//The Status&Control(SC) register needs to be configured
	TPM0->SC |= 1<<5;
	TPM0->SC |= 1 << 7; //Clear TOF before start,
	TPM0->SC |= 1 << 6; //Enable TOIE for interrupt
	TPM0->SC |= 1 << 3; //enable internal clock to run
	TPM0->SC |= 0xE;
	/*
	// Alternatively, can use the MKL25z4.h MACROs for self-documenting code
	TPM0->SC |= TPM_SC_TOF_MASK; //Clear TOF before start,
	TPM0->SC |= TPM_SC_PS(7); //optional pre-scale by 2^7 =128
	TPM0->SC |= TPM_SC_TOIE_MASK; //Enable TOIE for interrupt
	TPM0->SC |= TPM_SC_CMOD(1); //enable internal clock to run
	*/
	NVIC->ICPR[0] = 1 << 17; // clear pending interrupt 17 for TPM0
	NVIC->IP[4] = 0x3 << 8; // set priority of TPM0 to "3"
	NVIC->ISER[0] = 1 << 17; // enable interrupt 17 for TPM0
	/*
	// Alternatively, can use the CMSIS API (pp. 107 of the Dean textbook)
	NVIC_ClearPendingIRQ(TPM0_IRQn);
	NVIC_SetPriority(TPM0_IRQn, 3);
	NVIC_EnableIRQ(TPM0_IRQn);
	*/
}

void forSqaure(){
	if(waveNumber == 0){
		squareWave();
		waveNumber = 1;

	}
	if(waveNumber ==1){
		waveNumber = 0;
	}
}

void forSawTooth(){
	if(waveNumber == 2){
		sawTooth();
		waveNumber = 3;
	}
	if(waveNumber == 3){
		waveNumber = 2;
	}
}

void forTriangle(){

	if(waveNumber == 4){
		triangular();
		waveNumber = 5;
	}
	if(waveNumber == 5){
		waveNumber = 4;
	}

}

void forSine(){
	if(waveNumber == 6){
		sineWave();
		waveNumber = 7;
	}
	if(waveNumber == 7){
		waveNumber =6;
	}

}

// the IRQ handler
int TPM0_IRQHandler(){
	//interrupt frequency should be MCGCLK / TPM0 prescale / TPM0 MOD value
	//								20.9 MHz / 127 / 16300 = 10.0 Hz

	//								48 MHz / 32 / mod = 100 Hz


	// testing
	PTB->PDOR |= (1 << LED_RED);		//led on
//	if(run_square){
//		squareWave();
//	}else if(run_sine){
//		sineWave();
//	}else if(run_saw){
//		sawTooth();
//	}else if(run_tri){
//		triangular();
//	}else{
//		squareWave();
//	}


	forSqaure();

	forSawTooth();

	forTriangle();

	forSine();





	TPM0->SC |= TPM_SC_TOF_MASK ; //clear the interrupt

	// testing
	PTB->PDOR &=~ (1 << LED_RED);		//led off

	return;

}

// the various waves


void increaseDutyCycle(){
	currentDuty+=10;
	if(currentDuty>=90){
		currentDuty = 90;
	}

}
//void tostring(char str[], int currentDuty)

void decreaseDutyCycle(){

	if(currentDuty<10){
		currentDuty = 10;
	}else{
		currentDuty-=10;
	}
//	makeRsLow();
//		makeRwLow();
//		LCD_command(0xC0); // change cursor
//		LCD_write_word("DutyCycle"(currentDuty));

}

void callIRQ(){

}


// the keyPad call
void callKeyPad(){





	// ROW1 is on
		PTD->PDOR  |= (1 << ROW0);		//led on
		PTD->PDOR  &=~ (1 << ROW1);		//led off
		PTD->PDOR  |= (1 << ROW2);		//led off
		PTD->PDOR  |= (1 << ROW3);		//led off
		delay_us(2);		//wait
		if((~(PTB->PDIR) & MASK(COL0))){
			LCD_write_string('4');  // number 4
			LCD_init();
			delay_ms(2);
			LCD_write_word("400HZ");
			if(waveNumber == 0 || waveNumber == 1){
				init_Timer();
				DAC_init();
				modValue = modSquareValue[3];
			}
			// for sawTooth
			if(waveNumber == 2 || waveNumber == 3){
				init_Timer();
				DAC_init();
				modValue = 1500;
				Sawtooth_Frequency= sawToothFrequency[3];
			}
			// sine
			if(waveNumber == 6 || waveNumber == 7){
				init_Timer();
				DAC_init();
				modValue = 250;
				sineFrequency = sineFrequencyArr[3];
			}
			// triangle
			if(waveNumber == 4 || waveNumber == 5){
				init_Timer();
				DAC_init();
				modValue = currentMod;
				Triangular_Frequency = triangularFrequency[3]  ;
			}
			delay_ms(250);		//wait
	}

		else if((~(PTB->PDIR) & MASK(COL1))){
			LCD_write_string('5'); // number 5
			LCD_init();
			delay_ms(2);
			LCD_write_word("500HZ");
			if(waveNumber == 0 || waveNumber == 1){
				init_Timer();
				DAC_init();
				modValue = modSquareValue[4];
			}
			// for sawTooth
			if(waveNumber == 2 || waveNumber == 3){
				init_Timer();
				DAC_init();
				modValue = 1500;
				Sawtooth_Frequency= sawToothFrequency[4];
			}
			// sine
			if(waveNumber == 6 || waveNumber == 7){
				init_Timer();
				DAC_init();
				modValue = 250;
				sineFrequency = sineFrequencyArr[4];
			}
			// triangle
			if(waveNumber == 4 || waveNumber == 5){
				init_Timer();
				DAC_init();
				modValue = currentMod;
				Triangular_Frequency = triangularFrequency[4]  ;
			delay_ms(250);		//wait
	}
		}
		else if((~(PTB->PDIR) & MASK(COL2))){
			LCD_write_string('6'); // Number 6
			LCD_init();
			delay_ms(2);
			LCD_write_word("sine");
			waveNumber = 6; // or 7 for sine
			modValue = 250;
			sineFrequency = 3; // default
			delay_ms(250);		//wait

	}
		else if((~(PTB->PDIR) & MASK(COL3))){
			//LCD_write_string('B');
			delay_ms(250);		//wait
	}



	// ROW0 is on
		PTD->PDOR  &=~ (1 << ROW0);		//led on
		PTD->PDOR  |= (1 << ROW1);		//led off
		PTD->PDOR  |= (1 << ROW2);		//led off
		PTD->PDOR  |= (1 << ROW3);		//led off
		delay_us(2);		//wait
		if((~(PTB->PDIR) & MASK(COL0))){
			LCD_write_string('1');  // number 1
			LCD_init();
			delay_ms(2);
			LCD_write_word("100HZ");
			//square
			if(waveNumber == 0 || waveNumber == 1){
				init_Timer();
				DAC_init();
				modValue = modSquareValue[0] ;
			}
			//sawTooth
			if(waveNumber == 2 || waveNumber == 3){
				init_Timer();
				DAC_init();
				modValue = 1500;
				Sawtooth_Frequency= sawToothFrequency[0];
			}
			// sine
			if(waveNumber == 6 || waveNumber == 7){
				init_Timer();
				DAC_init();
				modValue = 300;
				sineFrequency = sineFrequencyArr[0];
			}
			// triangle
			if(waveNumber == 4 || waveNumber == 5){
				init_Timer();
				DAC_init();
				modValue = currentMod;
				Triangular_Frequency = triangularFrequency[0]  ;
			delay_ms(250);		//wait

		}
		}

		else if((~(PTB->PDIR) & MASK(COL1))){
			LCD_write_string('2');  // number 2
			LCD_init();
			delay_ms(2);
			LCD_write_word("200HZ");

			// for sqaure
			if(waveNumber == 0 || waveNumber == 1){
				init_Timer();
				DAC_init();
				modValue = modSquareValue[1];
			}
			// for sawTooth
			if(waveNumber == 2 || waveNumber == 3){
				init_Timer();
				DAC_init();
				modValue = 1500;
				Sawtooth_Frequency= sawToothFrequency[1];
			}
			// sine
			if(waveNumber == 6 || waveNumber == 7){
				init_Timer();
				DAC_init();
				modValue = 300;
				sineFrequency = sineFrequencyArr[1];
			}
			// triangle
			if(waveNumber == 4 || waveNumber == 5){
				init_Timer();
				DAC_init();
				modValue = currentMod;
				Triangular_Frequency = triangularFrequency[1]  ;
			delay_ms(250);		//wait

	}
		}
		else if((~(PTB->PDIR) & MASK(COL2))){
			LCD_write_string('3'); // number 3
			LCD_init();
			delay_ms(2);
			LCD_write_word("300HZ");
			if(waveNumber == 0 || waveNumber == 1){
				init_Timer();
				DAC_init();
				modValue = modSquareValue[2];
			}
			// for sawTooth
			if(waveNumber == 2 || waveNumber == 3){
				init_Timer();
				DAC_init();
				modValue = 1500;
				Sawtooth_Frequency= sawToothFrequency[2];
			}
			// sine
			if(waveNumber == 6 || waveNumber == 7){
				init_Timer();
				DAC_init();
				modValue = 300;
				sineFrequency = sineFrequencyArr[2];
			}
			// triangle
			if(waveNumber == 4 || waveNumber == 5){
				init_Timer();
				DAC_init();
				modValue = currentMod;
				Triangular_Frequency = triangularFrequency[2]  ;
			delay_ms(250);		//wait
	}
		}
		else if((~(PTB->PDIR) & MASK(COL3))){
			//LCD_write_string('A');
			delay_ms(250);		//wait
	}



	// ROW2 is on
		PTD->PDOR  |= (1 << ROW0);		//led on
		PTD->PDOR  |= (1 << ROW1);		//led off
		PTD->PDOR  &=~ (1 << ROW2);		//led off
		PTD->PDOR  |= (1 << ROW3);		//led off
		delay_us(2);		//wait
		if((~(PTB->PDIR) & MASK(COL0))){
			LCD_write_string('7');
			LCD_init();
			delay_ms(2);
			LCD_write_word("triangle");
			waveNumber = 4;
			modValue = currentMod;
			delay_ms(250);		//wait
	}

		else if((~(PTB->PDIR) & MASK(COL1))){
			LCD_write_string('8'); // number 8
			LCD_init();
			delay_ms(2);
			LCD_write_word("sawtooth");
			waveNumber = 2; // or 3 for sawTooth
			modValue = 1500;
			delay_ms(250);		//wait
	}
		else if((~(PTB->PDIR) & MASK(COL2))){
			LCD_write_string('9'); // number 9
			LCD_init();
			delay_ms(2);
			LCD_write_word("square");
			waveNumber = 0;   // or 1 for SquareWave
			modValue =3400;  // 100Hz default
			delay_ms(250);		//wait
	}
		else if((~(PTB->PDIR) & MASK(COL3))){
			//LCD_write_string('C');
			delay_ms(250);		//wait
	}


	// ROW3 is on
		PTD->PDOR  |= (1 << ROW0);		//led on
		PTD->PDOR  |= (1 << ROW1);		//led off
		PTD->PDOR  |= (1 << ROW2);		//led off
		PTD->PDOR  &=~ (1 << ROW3);		//led off
		delay_us(2);		//wait
		if((~(PTB->PDIR) & MASK(COL0))){
//			makeRsLow();
//			makeRwLow();
//			LCD_command(0xC0); // change cursor
//			LCD_write_string('*');
			// decrease the dutyCycle
			decreaseDutyCycle();
			delay_ms(250);		//wait

	}

		else if((~(PTB->PDIR) & MASK(COL1))){
			//LCD_write_string('0');
			// dutyCycle is 50
			currentDuty = 50;
			delay_ms(250);		//wait

	}
		else if((~(PTB->PDIR) & MASK(COL2))){
			makeRsLow();
						makeRwLow();
						LCD_command(0xC0); // change cursor
			LCD_write_string('#');
			// increase the dutyCycle
			increaseDutyCycle();
			delay_ms(250);		//wait


	}
		else if((~(PTB->PDIR) & MASK(COL3))){
			//LCD_write_string('D');
			delay_ms(250);		//wait
	}




}


void keypadInit(){


	SIM->SCGC5|= (1UL<<12) ; 				//clock gating to port D
	SIM->SCGC5|= (1UL<<10) ;


	//set up pin as GPIO --> configure mux to connect pins as GPIO
	// PORT D
	PORTB->PCR[COL0] &= ~0x700;   		//Clr mux bits since undefined at reset
	PORTB->PCR[COL0] |= (1UL<<8); 		//Set mux bits for GPIO function
	PORTB->PCR[COL0] |=  0x003;		//Set pull enable and pull select to high

	PORTB->PCR[COL1] &= ~0x700;   		//Clr mux bits since undefined at reset
	PORTB->PCR[COL1] |= (1UL<<8); 		//Set mux bits for GPIO function
	PORTB->PCR[COL1] |=  0x003;		//Set pull enable and pull select to high

	PORTB->PCR[COL2] &= ~0x700;   		//Clr mux bits since undefined at reset
	PORTB->PCR[COL2] |= (1UL<<8); 		//Set mux bits for GPIO function
	PORTB->PCR[COL2] |=  0x003;		//Set pull enable and pull select to high

	PORTB->PCR[COL3] &= ~0x700;   		//Clr mux bits since undefined at reset
	PORTB->PCR[COL3] |= (1UL<<8); 		//Set mux bits for GPIO function
	PORTB->PCR[COL3] |=  0x003;		//Set pull enable and pull select to high

	PORTD->PCR[ROW0] &= ~0x700;   		//Clr mux bits since undefined at reset
	PORTD->PCR[ROW0] |= (1UL<<8); 		//Set mux bits for GPIO function

	PORTD->PCR[ROW1] &= ~0x700;   		//Clr mux bits since undefined at reset
	PORTD->PCR[ROW1] |= (1UL<<8); 		//Set mux bits for GPIO function

	PORTD->PCR[ROW2] &= ~0x700;   		//Clr mux bits since undefined at reset
	PORTD->PCR[ROW2] |= (1UL<<8); 		//Set mux bits for GPIO function

	PORTD->PCR[ROW3] &= ~0x700;   		//Clr mux bits since undefined at reset
	PORTD->PCR[ROW3] |= (1UL<<8); 		//Set mux bits for GPIO function

	//set up KEYPAD to be output
	PTD->PDDR |=  (1 << ROW0 ) ;
	PTD->PDDR |=  (1 << ROW1 ) ;
	PTD->PDDR |=  (1 << ROW2 ) ;
	PTD->PDDR |=  (1 << ROW3 ) ;
	//set up KEYPAD to be input
	PTB->PDDR &=~  (1 << COL0 ) ;
	PTB->PDDR &=~  (1 << COL1 ) ;
	PTB->PDDR &=~  (1 << COL2 ) ;
	PTB->PDDR &=~  (1 << COL3 ) ;


	PTD->PDOR  |= (1 << ROW0);		//led off
	PTD->PDOR  |= (1 << ROW1);		//led off
	PTD->PDOR  |= (1 << ROW2);		//led off
	PTD->PDOR  |= (1 << ROW3);		//led off



}


